
<!DOCTYPE html>
<html>
<head>
    <title>Petrol Pump Locator</title>
    <style>
        #map {{
            height: 90vh;
            width: 100%;
        }}
        #controls {{
            margin: 10px;
        }}
    </style>
</head>
<body>
    <h2>Petrol Pump Locator</h2>
    <div id="controls">
        <input type="text" id="from" placeholder="From Location">
        <input type="text" id="to" placeholder="To Location">
        <input type="text" id="search" placeholder="Search by City or State">
        <button onclick="filterPumps()">Search</button>
    </div>
    <div id="map"></div>

    <script>
        let map;
        let markers = [];
        let directionsService;
        let directionsRenderer;
        let pumps = [];

        async function initMap() {{
            map = new google.maps.Map(document.getElementById("map"), {{
                center: {{ lat: 20.5937, lng: 78.9629 }},
                zoom: 5,
            }});

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            const response = await fetch('pumps_data.csv');
            const data = await response.text();
            const rows = data.split('\n').slice(1);
            for (let row of rows) {{
                const cols = row.split(',');
                if (cols.length < 8) continue;
                pumps.push({{
                    dealerCode: cols[0],
                    name: cols[1],
                    city: cols[2],
                    state: cols[3],
                    pincode: cols[4],
                    fuelPrice: cols[5],
                    lat: parseFloat(cols[6]),
                    lng: parseFloat(cols[7])
                }});
            }}
            displayMarkers(pumps);
        }}

        function displayMarkers(pumpsList) {{
            for (let marker of markers) {{
                marker.setMap(null);
            }}
            markers = [];
            for (let pump of pumpsList) {{
                const marker = new google.maps.Marker({{
                    position: {{ lat: pump.lat, lng: pump.lng }},
                    map: map,
                    title: pump.name
                }});
                const infoWindow = new google.maps.InfoWindow({{
                    content: `<strong>${{pump.name}}</strong><br>
                              City: ${{pump.city}}<br>
                              State: ${{pump.state}}<br>
                              Pincode: ${{pump.pincode}}<br>
                              Fuel Price: â‚¹${{pump.fuelPrice}}`
                }});
                marker.addListener("click", () => {{
                    infoWindow.open(map, marker);
                }});
                markers.push(marker);
            }}
        }}

        function filterPumps() {{
            const from = document.getElementById("from").value;
            const to = document.getElementById("to").value;
            const search = document.getElementById("search").value.toLowerCase();

            let filtered = pumps.filter(p => 
                p.city.toLowerCase().includes(search) || 
                p.state.toLowerCase().includes(search)
            );

            if (from && to) {{
                directionsService.route({{
                    origin: from,
                    destination: to,
                    travelMode: google.maps.TravelMode.DRIVING,
                }}, (response, status) => {{
                    if (status === "OK") {{
                        directionsRenderer.setDirections(response);
                        const route = response.routes[0].overview_path;
                        filtered = filtered.filter(pump => {{
                            return route.some(point => {{
                                const dist = google.maps.geometry.spherical.computeDistanceBetween(
                                    new google.maps.LatLng(pump.lat, pump.lng),
                                    point
                                );
                                return dist < 5000;
                            }});
                        }});
                        displayMarkers(filtered);
                    }} else {{
                        alert("Directions request failed due to " + status);
                    }}
                }});
            }} else {{
                displayMarkers(filtered);
            }}
        }}
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3v-OqI83pLDVoWzbeYhlK-T8JGfJGOcU&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>
